# Novita Arena - 技术规范

**版本**: 2.0
**最后更新**: 2025-01-18
**产品名称**: Novita Arena

---

## 目录

1. [技术架构](#1-技术架构)
2. [数据库设计](#2-数据库设计)
3. [API 接口概览](#3-api-接口概览)
4. [开发环境配置](#4-开发环境配置)

---

## 1. 技术架构

### 1.1 整体架构

**v2.0 简化架构**: 单次 LLM 调用直接生成 HTML，无需 Sandbox 和构建步骤。

```
┌─────────────────────────────────────────────────────────────┐
│                         前端层                               │
├─────────────────────────────────────────────────────────────┤
│  Next.js 15+  │  React 19+  │  Tailwind CSS  │  shadcn/ui  │
└─────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────┐
│                      API 路由层                              │
├─────────────────────────────────────────────────────────────┤
│  Next.js API Routes  │  认证中间件  │  速率限制               │
└─────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────┐
│                      业务逻辑层                              │
├─────────────────────────────────────────────────────────────┤
│  LLM 调用（流式）  │  HTML 生成  │  账户/额度                │
└─────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────┐
│                    外部服务集成                              │
├─────────────────────────────────────────────────────────────┤
│  Novita LLM API  │  Novita Auth  │  Cloudflare Stream       │
└─────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────┐
│                      数据存储层                              │
├─────────────────────────────────────────────────────────────┤
│  Supabase (PostgreSQL)  │  HTML 内容直接存储                 │
└─────────────────────────────────────────────────────────────┘
```

### 1.2 技术选型

#### 前端技术栈

| 技术 | 版本/说明 | 用途 |
|------|----------|------|
| **Next.js** | 15+ | 全栈框架，前后端统一 |
| **React** | 19+ | UI 框架 |
| **TypeScript** | 5.x | 类型安全 |
| **Tailwind CSS** | 4.x | 样式系统 |
| **shadcn/ui** | Latest | UI 组件库 |
| **OpenAI SDK** | Latest | 流式 LLM 调用 |

#### 后端技术栈

| 技术 | 说明 | 用途 |
|------|------|------|
| **Next.js API Routes** | 服务端 API | 业务逻辑处理 |
| **Novita LLM API** | 外部服务 | AI 代码生成（流式） |
| **Novita Auth** | 外部服务 | 统一认证 |
| **Cloudflare Stream** | 外部服务 | 视频存储 |

#### 数据与存储

| 技术 | 说明 | 用途 |
|------|------|------|
| **Supabase** | PostgreSQL | 主数据库 |
| **TEXT 字段** | HTML 内容 | 直接存储生成的 HTML（≤1MB） |

### 1.3 v1.x vs v2.0 架构对比

| 方面 | v1.x（旧） | v2.0（新） |
|------|-----------|-----------|
| **生成方式** | Coding Agent 多轮对话 | 单次 LLM 调用 |
| **代码格式** | React + Vite 项目 | 单文件 HTML |
| **构建** | 需要 npm install + vite build | 无需构建 |
| **预览** | Sandbox 托管 + iframe | iframe srcdoc 直接渲染 |
| **部署** | Vercel 部署 | 无需部署，直接预览 |
| **复杂度** | 高（多组件协调） | 低（单次调用） |
| **生成时间** | 60-120s | 10-30s |

### 1.4 生成流程

```
1. 用户在首页选择灵感和效果库（或直接输入 Prompt）
   ↓
2. 前端调用 Next.js API (POST /api/apps/create)
   Body: {
     prompt: "创建一个 3D 时钟...",
     modelA: "deepseek/deepseek-v3-0324",
     modelB: "meta-llama/llama-3.1-70b-instruct"
   }
   ↓
3. API 验证用户认证与额度，创建 app 记录
   ↓
4. 前端并行发起两个 SSE 请求
   GET /api/apps/{id}/generate?model=a
   GET /api/apps/{id}/generate?model=b
   ↓
5. 后端并行调用 Novita LLM API（双模型）
   - 使用系统提示词约束输出格式
   - 流式返回生成内容
   ↓
6. 前端流式展示生成过程（Markdown 代码块风格）
   ↓
7. 生成完成，提取 HTML 内容，保存到数据库
   ↓
8. 前端验证 HTML，自动修复（如需要）
   ↓
9. 切换到预览模式，使用 iframe srcdoc 渲染
```

---

## 2. 数据库设计

### 2.1 数据表设计

#### apps (应用表)

```sql
CREATE TABLE apps (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id VARCHAR(255) NOT NULL,  -- users.id 或 IP 地址

  -- 应用信息
  name VARCHAR(255),
  description TEXT,
  prompt TEXT NOT NULL,

  -- 模型配置
  model_a VARCHAR(100) NOT NULL,
  model_b VARCHAR(100) NOT NULL,

  -- 生成的 HTML 内容
  html_content_a TEXT,
  html_content_b TEXT,

  -- 媒体资源
  preview_video_url TEXT,

  -- 互动数据
  like_count INTEGER DEFAULT 0,
  view_count INTEGER DEFAULT 0,

  -- 公开状态
  is_public BOOLEAN DEFAULT FALSE,

  -- 时间戳
  created_at TIMESTAMP DEFAULT NOW(),
  updated_at TIMESTAMP DEFAULT NOW()
);
```

#### users (用户表)

```sql
CREATE TABLE users (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),

  -- Novita Auth 关联
  novita_user_id VARCHAR(255) UNIQUE NOT NULL,
  novita_uuid VARCHAR(255) UNIQUE NOT NULL,

  -- 用户信息
  email VARCHAR(255),
  username VARCHAR(100),
  first_name VARCHAR(100),
  last_name VARCHAR(100),
  tier VARCHAR(50),

  -- API Key
  novita_api_key VARCHAR(255),

  -- 时间戳
  created_at TIMESTAMP DEFAULT NOW(),
  updated_at TIMESTAMP DEFAULT NOW()
);
```

#### ip_usage (IP 使用记录)

```sql
CREATE TABLE ip_usage (
  ip VARCHAR(45) PRIMARY KEY,
  used_count INTEGER DEFAULT 1,
  first_used_at TIMESTAMP DEFAULT NOW(),
  last_used_at TIMESTAMP DEFAULT NOW()
);
```

#### likes (点赞表)

```sql
CREATE TABLE likes (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  app_id UUID REFERENCES apps(id) ON DELETE CASCADE,
  user_id UUID REFERENCES users(id) ON DELETE CASCADE,
  created_at TIMESTAMP DEFAULT NOW(),
  UNIQUE(app_id, user_id)
);
```

---

## 3. API 接口概览

### 3.1 认证接口

| 接口 | 方法 | 描述 |
|------|------|------|
| `/api/auth` | GET | Novita Auth 回调 |
| `/api/auth/me` | GET | 获取当前用户信息 |
| `/api/auth/save-api-key` | POST | 保存 Novita API Key |
| `/api/auth/logout` | POST | 登出 |

### 3.2 生成接口

| 接口 | 方法 | 描述 |
|------|------|------|
| `/api/apps/create` | POST | 创建 App（生成任务） |
| `/api/apps/:id/generate` | GET | 流式生成 HTML（SSE） |
| `/api/apps/:id` | GET | 获取 App 详情 |
| `/api/apps/:id/update` | POST | 更新 App 信息 |

### 3.3 媒体接口

| 接口 | 方法 | 描述 |
|------|------|------|
| `/api/media/upload-url` | POST | 获取视频上传 URL |
| `/api/apps/:id/generate-name` | POST | AI 生成应用名称（可选） |

### 3.4 画廊接口

| 接口 | 方法 | 描述 |
|------|------|------|
| `/api/apps` | GET | 获取应用列表 |
| `/api/apps/:id/publish` | POST | 发布到画廊 |
| `/api/apps/:id/like` | POST | 点赞应用 |
| `/api/apps/:id/view` | POST | 增加浏览次数 |

---

## 4. 开发环境配置

### 4.1 环境变量

```bash
# Novita API 配置
NOVITA_API_KEY=your_api_key
NOVITA_API_BASE_URL=https://api.novita.ai/v3/openai

# Novita Auth 配置
NOVITA_AUTH_ENDPOINT=https://api.novita.ai

# Supabase 配置
NEXT_PUBLIC_SUPABASE_URL=your_supabase_url
NEXT_PUBLIC_SUPABASE_ANON_KEY=your_supabase_anon_key
NEXT_SUPABASE_SERVICE_ROLE_KEY=your_service_role_key

# Cloudflare Stream 配置
CLOUDFLARE_ACCOUNT_ID=your_account_id
CLOUDFLARE_API_TOKEN=your_api_token

# 应用配置
NEXT_PUBLIC_APP_URL=http://localhost:3000
```

### 4.2 项目结构

```
novita-arena/
├── app/                      # Next.js App Router
│   ├── (auth)/              # 认证相关路由
│   ├── gallery/             # 画廊页面
│   ├── playground/          # 创作页面
│   ├── g/[id]/              # 分享页面
│   ├── api/                 # API 路由
│   │   ├── auth/            # 认证接口
│   │   ├── apps/            # 应用管理
│   │   └── media/           # 媒体上传
│   ├── layout.tsx
│   └── page.tsx
├── components/
│   ├── ui/                  # shadcn/ui 组件
│   ├── app/                 # 应用特定组件
│   └── layout/              # 布局组件
├── lib/
│   ├── novita/              # Novita 服务集成
│   │   ├── llm.ts           # LLM 调用
│   │   └── auth.ts          # 认证
│   ├── supabase/            # Supabase 客户端
│   ├── cloudflare/          # Cloudflare Stream
│   └── utils.ts             # 工具函数
├── types/                   # TypeScript 类型
├── hooks/                   # React Hooks
├── docs/                    # 文档
├── .env.local
├── next.config.ts
├── package.json
└── tailwind.config.ts
```

---

## 相关文档

- **产品概览**: 详见 [00-产品概览.md](./00-产品概览.md)
- **页面设计**: 详见 [02-页面规范.md](./02-页面规范.md)
- **运营设计**: 详见 [03-运营与设计.md](./03-运营与设计.md)
- **详细技术文档**: 详见 [/docs/tech/](../tech/)
