# Novita Arena - 数据库设计

**版本**: 2.0
**最后更新**: 2026-01-19
**状态**: 已实现

---

## 目录

1. [数据表设计](#1-数据表设计)
2. [索引设计](#2-索引设计)
3. [RLS 策略](#3-rls-策略)
4. [辅助函数与触发器](#4-辅助函数与触发器)
5. [使用说明](#5-使用说明)

---

## 1. 数据表设计

### 1.1 users（用户表）

**用途**：存储用户信息（对接 Novita Auth）

```sql
-- 启用加密扩展
CREATE EXTENSION IF NOT EXISTS pgcrypto;

-- 创建用户表
CREATE TABLE public.users (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  novita_user_id VARCHAR(255) UNIQUE NOT NULL, -- Novita 的唯一标识
  novita_uuid VARCHAR(255) UNIQUE NOT NULL,    -- Novita 的内部 UUID
  email VARCHAR(255),
  username VARCHAR(100),
  first_name VARCHAR(100),
  last_name VARCHAR(100),
  tier VARCHAR(50) DEFAULT 'free',
  novita_api_key TEXT, -- 加密存储
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- 启用行级安全性 (RLS)
ALTER TABLE public.users ENABLE ROW LEVEL SECURITY;

-- 创建 RLS 策略：用户只能查看和更新自己的数据
CREATE POLICY "Users can view own profile" 
  ON public.users FOR SELECT 
  USING (auth.uid() = id);

CREATE POLICY "Users can update own profile" 
  ON public.users FOR UPDATE 
  USING (auth.uid() = id);
```

**字段说明**：
| 字段 | 类型 | 说明 |
|------|------|------|
| id | UUID | 内部用户 ID |
| novita_user_id | VARCHAR(255) | Novita 返回的 uid（如 "275"），唯一 |
| novita_uuid | VARCHAR(255) | Novita 返回的 uuid，唯一 |
| email | VARCHAR(255) | 用户邮箱 |
| username | VARCHAR(100) | 用户名 |
| first_name | VARCHAR(100) | 名 |
| last_name | VARCHAR(100) | 姓 |
| tier | VARCHAR(50) | 用户等级，默认 'free' |
| novita_api_key | TEXT | 用户的 Novita API Key（加密存储） |
| created_at | TIMESTAMP WITH TIME ZONE | 创建时间 |
| updated_at | TIMESTAMP WITH TIME ZONE | 更新时间 |

**API Key 加密/解密函数**：
```sql
CREATE OR REPLACE FUNCTION encrypt_api_key(api_key TEXT, master_key TEXT)
RETURNS TEXT AS $$
BEGIN
  RETURN encode(pgp_sym_encrypt(api_key, master_key), 'base64');
END;
$$ LANGUAGE plpgsql SECURITY DEFINER;

CREATE OR REPLACE FUNCTION decrypt_api_key(encrypted_key TEXT, master_key TEXT)
RETURNS TEXT AS $$
BEGIN
  RETURN pgp_sym_decrypt(decode(encrypted_key, 'base64'), master_key);
END;
$$ LANGUAGE plpgsql SECURITY DEFINER;
```

---

### 1.2 apps（应用表）

**用途**：存储生成的应用信息和 HTML 内容

```sql
CREATE TABLE IF NOT EXISTS apps (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id VARCHAR(255),  -- users.id（登录用户）或 NULL（匿名用户）
  user_email VARCHAR(255),  -- 创建者的邮箱（冗余存储，避免关联查询）

  -- 应用信息
  name VARCHAR(255),
  description TEXT,
  prompt TEXT NOT NULL,
  category VARCHAR(50) DEFAULT '',  -- 分类: physics, visual, game

  -- 模型配置
  model_a VARCHAR(100) NOT NULL,
  model_b VARCHAR(100) NOT NULL,

  -- 生成的 HTML 内容
  html_content_a TEXT,  -- 模型 A 生成的完整 HTML
  html_content_b TEXT,  -- 模型 B 生成的完整 HTML

  -- 媒体资源（暂时不用）
  preview_video_url TEXT,

  -- 互动数据
  like_count INTEGER DEFAULT 0,
  view_count INTEGER DEFAULT 0,

  -- 公开状态
  is_public BOOLEAN DEFAULT FALSE,

  -- 时间戳
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- 索引
CREATE INDEX IF NOT EXISTS idx_apps_user_id ON apps(user_id);
CREATE INDEX IF NOT EXISTS idx_apps_is_public ON apps(is_public);
CREATE INDEX IF NOT EXISTS idx_apps_created_at ON apps(created_at DESC);
CREATE INDEX IF NOT EXISTS idx_apps_like_count ON apps(like_count DESC);
CREATE INDEX IF NOT EXISTS idx_apps_user_id_created ON apps(user_id, created_at DESC);
CREATE INDEX IF NOT EXISTS idx_apps_public_created ON apps(is_public, created_at DESC);
CREATE INDEX IF NOT EXISTS idx_apps_public_likes ON apps(is_public, like_count DESC);
CREATE INDEX IF NOT EXISTS idx_apps_category ON apps(category);
```

**字段说明**：
| 字段 | 类型 | 说明 |
|------|------|------|
| id | UUID | 应用 ID |
| user_id | VARCHAR(255) | 已登录用户存储 users.id，匿名用户为 NULL |
| user_email | VARCHAR(255) | 创建者的邮箱（冗余存储，避免关联查询） |
| name | VARCHAR(255) | 应用名称 |
| description | TEXT | 应用描述 |
| prompt | TEXT | 用户输入的 prompt（必填） |
| category | VARCHAR(50) | 分类: physics, visual, game，默认为空字符串 |
| model_a | VARCHAR(100) | 模型 A 标识（必填） |
| model_b | VARCHAR(100) | 模型 B 标识（必填） |
| html_content_a | TEXT | 模型 A 生成的 HTML |
| html_content_b | TEXT | 模型 B 生成的 HTML |
| preview_video_url | TEXT | 录屏视频 URL（暂时不用） |
| like_count | INTEGER | 点赞数，默认 0 |
| view_count | INTEGER | 浏览数，默认 0 |
| is_public | BOOLEAN | 是否发布到画廊，默认 false |
| created_at | TIMESTAMP WITH TIME ZONE | 创建时间 |
| updated_at | TIMESTAMP WITH TIME ZONE | 更新时间 |

---

### 1.3 ip_usage（IP 使用记录）

**用途**：记录匿名用户的免费额度使用

```sql
CREATE TABLE IF NOT EXISTS ip_usage (
  ip VARCHAR(45) PRIMARY KEY,  -- IPv4 或 IPv6
  used_count INTEGER DEFAULT 1,
  first_used_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  last_used_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);
```

**字段说明**：
| 字段 | 类型 | 说明 |
|------|------|------|
| ip | VARCHAR(45) | 用户 IP 地址（支持 IPv6），主键 |
| used_count | INTEGER | 已使用次数，默认 1 |
| first_used_at | TIMESTAMP WITH TIME ZONE | 首次使用时间 |
| last_used_at | TIMESTAMP WITH TIME ZONE | 最后使用时间 |

---

### 1.4 likes（点赞表）

**用途**：记录用户点赞（防止重复）

```sql
CREATE TABLE IF NOT EXISTS likes (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  app_id UUID REFERENCES apps(id) ON DELETE CASCADE,
  user_id UUID REFERENCES users(id) ON DELETE CASCADE,

  -- 时间戳
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),

  -- 唯一约束（只允许登录用户点赞，每个用户每个 app 只能点赞一次）
  UNIQUE(app_id, user_id)
);

-- 索引
CREATE INDEX IF NOT EXISTS idx_likes_app_id ON likes(app_id);
CREATE INDEX IF NOT EXISTS idx_likes_user_id ON likes(user_id);
CREATE INDEX IF NOT EXISTS idx_likes_created ON likes(created_at DESC);
```

**字段说明**：
| 字段 | 类型 | 说明 |
|------|------|------|
| id | UUID | 点赞记录 ID |
| app_id | UUID | 关联的应用（外键，级联删除） |
| user_id | UUID | 点赞的用户（外键，级联删除） |
| created_at | TIMESTAMP WITH TIME ZONE | 点赞时间 |

---

## 2. 索引设计

### 2.1 apps 表索引

```sql
CREATE INDEX IF NOT EXISTS idx_apps_user_id ON apps(user_id);
CREATE INDEX IF NOT EXISTS idx_apps_is_public ON apps(is_public);
CREATE INDEX IF NOT EXISTS idx_apps_created_at ON apps(created_at DESC);
CREATE INDEX IF NOT EXISTS idx_apps_like_count ON apps(like_count DESC);
CREATE INDEX IF NOT EXISTS idx_apps_user_id_created ON apps(user_id, created_at DESC);  -- 用户历史查询
CREATE INDEX IF NOT EXISTS idx_apps_public_created ON apps(is_public, created_at DESC);  -- 画廊列表（最新）
CREATE INDEX IF NOT EXISTS idx_apps_public_likes ON apps(is_public, like_count DESC);  -- 画廊列表（热门，无分类）
CREATE INDEX IF NOT EXISTS idx_apps_category ON apps(category);  -- 分类筛选

-- 优化分类+热门查询的 Partial Index
CREATE INDEX IF NOT EXISTS idx_apps_public_category_likes 
ON apps(is_public, category, like_count DESC)
WHERE is_public = true;  -- 只索引公开的 apps，减少索引大小
```

### 2.2 likes 表索引

```sql
CREATE INDEX IF NOT EXISTS idx_likes_app_id ON likes(app_id);
CREATE INDEX IF NOT EXISTS idx_likes_user_id ON likes(user_id);
CREATE INDEX IF NOT EXISTS idx_likes_created ON likes(created_at DESC);
```

---

## 3. RLS 策略

### 3.1 users 表 RLS

```sql
ALTER TABLE public.users ENABLE ROW LEVEL SECURITY;

-- 用户只能查看自己的数据
CREATE POLICY "Users can view own profile" 
  ON public.users FOR SELECT 
  USING (auth.uid() = id);

-- 用户只能更新自己的数据
CREATE POLICY "Users can update own profile" 
  ON public.users FOR UPDATE 
  USING (auth.uid() = id);
```

### 3.2 apps 表 RLS

```sql
ALTER TABLE apps ENABLE ROW LEVEL SECURITY;

-- 所有人可以查看公开的 apps
CREATE POLICY "Public apps are viewable by everyone" ON apps
  FOR SELECT USING (is_public = true);

-- 用户可以查看自己的 apps
CREATE POLICY "Users can view their own apps" ON apps
  FOR SELECT USING (auth.uid()::text = user_id);

-- 用户可以创建 apps
CREATE POLICY "Users can create apps" ON apps
  FOR INSERT WITH CHECK (true);

-- 用户可以更新自己的 apps
CREATE POLICY "Users can update their own apps" ON apps
  FOR UPDATE USING (auth.uid()::text = user_id);
```

### 3.3 ip_usage 表 RLS

```sql
ALTER TABLE ip_usage ENABLE ROW LEVEL SECURITY;

-- 只允许服务端操作（通过 service_role）
CREATE POLICY "Service role can manage ip_usage" ON ip_usage
  FOR ALL USING (true);
```

### 3.4 likes 表 RLS

```sql
ALTER TABLE likes ENABLE ROW LEVEL SECURITY;

-- 所有人可以查看点赞
CREATE POLICY "Likes are viewable by everyone" ON likes
  FOR SELECT USING (true);

-- 登录用户可以点赞
CREATE POLICY "Users can insert likes" ON likes
  FOR INSERT WITH CHECK (auth.uid() = user_id);

-- 用户可以取消自己的点赞
CREATE POLICY "Users can delete their own likes" ON likes
  FOR DELETE USING (auth.uid() = user_id);
```

---

## 4. 辅助函数与触发器

### 4.1 自动更新 updated_at 触发器

```sql
CREATE OR REPLACE FUNCTION update_updated_at_column()
RETURNS TRIGGER AS $$
BEGIN
    NEW.updated_at = NOW();
    RETURN NEW;
END;
$$ language 'plpgsql';

-- apps 表的更新触发器
DROP TRIGGER IF EXISTS update_apps_updated_at ON apps;
CREATE TRIGGER update_apps_updated_at
    BEFORE UPDATE ON apps
    FOR EACH ROW
    EXECUTE FUNCTION update_updated_at_column();
```

---

## 5. 使用说明

### 5.1 匿名用户逻辑

- `apps.user_id` 为 NULL
- IP 额度检查：查询 `ip_usage` 表
- 默认允许每个 IP 使用 N 次（可配置）
- 匿名用户**不能**点赞

### 5.2 已登录用户逻辑

- `apps.user_id` 存储 `users.id`（UUID 字符串）
- 创建 app 时检查 `users.novita_api_key` 是否存在
- 可以点赞（记录到 `likes` 表）
- 通过关联 users 表获取用户 email

### 5.3 HTML 内容存储

- 直接存储在 PostgreSQL TEXT 字段
- 区分模型 A 和模型 B 的内容

### 5.4 点赞计数

- 使用应用层逻辑维护 `apps.like_count`
- 每次插入/删除 `likes` 记录时更新

### 5.5 画廊查询

- 默认按 `like_count` 降序排序（热门优先）
- 支持分类筛选（physics, visual, game）
- 返回用户 email（通过关联 users 表）

---

## 相关文档

- **技术选型**: 详见 [00-技术选型.md](./00-技术选型.md)
- **使用流程**: 详见 [01-使用流程.md](./01-使用流程.md)
- **接口设计**: 详见 [02-接口设计.md](./02-接口设计.md)
