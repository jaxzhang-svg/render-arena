# Novita Arena - 使用流程

**版本**: 2.0
**最后更新**: 2025-01-18
**状态**: 设计阶段

---

## 目录

1. [主流程概览](#1-主流程概览)
2. [用户登录流程](#2-用户登录流程)
3. [HTML 生成流程](#3-html-生成流程)
4. [录屏上传流程](#4-录屏上传流程)
5. [分享流程](#5-分享流程)
6. [画廊浏览流程](#6-画廊浏览流程)
7. [核心状态机](#7-核心状态机)

---

## 1. 主流程概览

### 1.1 用户首次使用（匿名）

```
用户进入首页 → 浏览画廊 → 选择灵感 / 输入 Prompt → 点击"开始 PK"
  → 跳转到 Playground → 后端检查 IP 额度
  → 有额度 → 并行调用双模型 LLM API（流式）
  → 前端展示生成过程（Markdown 代码块风格）
  → 生成完成 → 验证 HTML → 预览（iframe srcdoc）
```

### 1.2 用户第二次使用（IP 超额）

```
用户进入首页 → 输入 Prompt → 点击"开始 PK"
  → 后端检查 IP 额度 → 已使用完
  → 弹框提示："免费次数已用完，需要登录才能继续"
  → 用户点击"去登录" → 跳转登录页面
```

### 1.3 已登录用户

```
用户进入首页 → 浏览画廊 → 点击"开始 PK"
  → 检查是否已填 API Key → 未填 → 显示 Banner：
     "请填写 Novita API Key 才能开始生成"
  → 用户填写 API Key → 开始生成
```

---

## 2. 用户登录流程

### 2.1 登录跳转

```
用户点击登录 → 存当前 URL 到 Cookie (redirect_url)
  → 跳转 https://api.novita.ai/login?redirect_url={domain}/api/auth
```

### 2.2 Novita 回调

```
用户完成登录 → Novita 后端 Set-Cookie
  → 跳转到 /api/auth
```

### 2.3 后端处理

```
/api/auth 接收请求 → 读取 Novita 设置的 Cookie
  → 调用 https://api-server.novita.ai/v1/user/info 获取用户信息
  → 提取字段：uuid, email, username, firstName, lastName, tier
  → 存储到 users 表（upsert）
  → 设置 Session (JWT)
  → 读取 Cookie 中的 redirect_url → 307 跳转
```

### 2.4 API Key 管理

```
用户登录后 → 首次生成 → 显示 Banner："请填写 Novita API Key"
  → 用户填写 Key
  → POST /api/auth/save-api-key → 后端保存到 users.novita_api_key
  → 验证 Key（调用 LLM API 检查是否有效）
  → 验证成功 → 允许生成
```

---

## 3. HTML 生成流程

### 3.1 创建生成任务

```
POST /api/apps/create
  → 检查用户登录状态
  → 如果未登录 → 检查 IP 额度 (ip_usage 表)
  → 如果已登录 → 检查 users.novita_api_key 是否存在
  → 生成 app_id (UUID)
  → 记录到 apps 表（prompt, model_a, model_b）
  → 返回 app_id
```

### 3.2 并行流式生成

```
前端收到 app_id → 并行发起两个流式请求：
  GET /api/apps/{app_id}/generate?model=a (SSE)
  GET /api/apps/{app_id}/generate?model=b (SSE)

后端处理每个请求：
  → 构建系统提示词 + 用户提示词
  → 调用 Novita LLM API（流式）
  → 逐 chunk 返回给前端（SSE）
  → 生成完成后，提取 HTML 内容
  → 保存到 apps.html_content_a 或 apps.html_content_b
  → 发送完成事件
```

### 3.3 前端流式展示

```
前端建立 SSE 连接 → 接收流式数据
  → 展示为 Markdown 代码块风格（终端风格）
  → 黑底等宽字体，打字机效果
  → 无语法高亮，减少视觉干扰
  → 自动滚动到底部
```

### 3.4 生成完成处理

```
收到完成事件 → 获取完整 HTML 内容
  → 调用 validateAndFixHTML()
  → 如果有效 → 切换到预览模式（iframe srcdoc）
  → 如果无效且可修复 → 使用修复后的 HTML
  → 如果无法修复 → 显示错误信息 + 重试按钮
```

### 3.5 HTML 验证和修复

```typescript
function validateAndFixHTML(html: string) {
  const parser = new DOMParser()
  const doc = parser.parseFromString(html, 'text/html')

  const hasError = !!doc.querySelector('parsererror')
  const fixedHTML = doc.body.innerHTML

  return {
    isValid: !hasError,
    fixedHTML,
    needsFix: html.trim() !== fixedHTML.trim(),
  }
}
```

---

## 4. 录屏上传流程

### 4.1 开始录制

```
用户点击"录制" → MediaRecorder.start()
  → 录制范围：整个标签页
  → 只读提示词显示在顶部（作为附加信息）
  → 最大时长：60s（硬限制）
```

### 4.2 录制控制

```
录制中 → 顶部显示计时器和控制按钮
  → 用户点击"完成" → MediaRecorder.stop()
  → 生成 WebM Blob
```

### 4.3 获取上传 URL

```
前端 POST /api/media/upload-url
  → 后端调用 Cloudflare Stream API 创建上传 URL
  → 返回：
     {
       uploadUrl: "https://upload.cloudflarestream.com/...",
       videoUid: "6b9e68b07dfee8cc2d116e4c51d6a957",
       previewUrl: "https://customer-{CODE}.cloudflarestream.com/.../watch"
     }
```

### 4.4 上传视频

```
前端使用 uploadUrl 上传 WebM Blob
  → POST 请求到 Cloudflare Stream
  → 上传完成后，前端已知道 previewUrl
```

### 4.5 保存视频 URL

```
前端 POST /api/apps/{app_id}/update
  → 后端更新 apps.preview_video_url
  → 返回成功
```

---

## 5. 分享流程

### 5.1 打开分享弹窗

```
录制完成 或 用户点击分享按钮 → 弹出分享框
  → 用户填写应用名称（可选调用 LLM 生成）
  → 显示视频预览
  → 选项：
     - 社交分享（X, LinkedIn, TikTok）
     - 复制链接
     - 发布到画廊
     - 下载 MP4
```

### 5.2 可选：LLM 生成应用名称

```
用户点击"AI 生成名称"按钮
  → POST /api/apps/{app_id}/generate-name
  → 后端调用 LLM：
     System: "根据提示词生成简洁的应用名称（不超过15字）"
     User: "{user_prompt}"
  → 返回生成的名称
  → 前端填充到输入框
```

### 5.3 发布到画廊

```
用户勾选"发布到画廊" + 填写名称 → POST /api/apps/{app_id}/publish
  → 更新 apps.name, apps.is_public = TRUE
  → 首页瀑布流显示该 app
```

### 5.4 分享链接

```
分享页面路由：/g/{app_id}
  → 查询 app 信息
  → 左右分屏显示两个模型的 HTML 预览（只读）
  → 显示应用信息（名称、提示词、模型）
  → 登录用户可点赞、复制提示词
```

---

## 6. 画廊浏览流程

### 6.1 浏览瀑布流

```
首页 → GET /api/apps?category=latest&page=1&limit=20
  → 返回公开的 apps（is_public = TRUE）
  → 按创建时间倒序或点赞数倒序
  → 瀑布流卡片显示：
     - 视频预览或静态缩略图
     - 应用名称
     - 模型标签（Model A vs Model B）
     - 点赞数
```

### 6.2 查看 App 详情

```
用户点击卡片 → 跳转 /g/{app_id}
  → 查询 app 信息和 HTML 内容
  → 左右分屏显示两个模型的 HTML（iframe srcdoc）
  → 显示只读预览
  → 登录用户可点赞
```

### 6.3 点赞功能

```
登录用户点击"点赞" → POST /api/apps/{app_id}/like
  → 检查是否已点赞（likes 表唯一约束）
  → 未点赞 → 插入 likes 表 → 更新 apps.like_count
  → 返回新的 like_count
```

### 6.4 复制提示词

```
用户点击"复制" → 复制 prompt 到剪贴板
  → 或跳转 Playground 自动填充 prompt
```

---

## 7. 核心状态机

### 7.1 Playground 页面状态

```
idle        → 空闲，等待输入
generating  → 正在生成（流式展示）
completed   → 生成完成，预览模式
error       → 生成失败，显示错误
recording   → 录制中
sharing     → 分享弹窗打开
```

### 7.2 状态转换

```
idle → 点击生成 → generating
generating → 生成完成 → completed
generating → 生成失败 → error
error → 点击重试 → generating
completed → 点击录制 → recording
recording → 点击完成 → sharing
sharing → 关闭弹窗 → completed
completed → 重新输入 → idle
```

### 7.3 输入控制台状态

```
状态 1: 输入时（未生成/重新编辑）
  - 显示灵感卡片 + 多行输入框 + 生成按钮
  - 可选择模型 A 和模型 B

状态 2: 生成中
  - 折叠为简洁只读条
  - 显示进度："正在生成..."
  - 停止按钮

状态 3: 生成完成 / 预览模式
  - 完全隐藏输入框
  - 顶部显示只读提示词（可点击展开编辑）
  - 录制按钮可用

状态 4: 录制中
  - 只读提示词条显示在顶部
  - 录制计时器和控制按钮
  - 完全收起底部输入框
```

### 7.4 双模型生成状态

```
每个模型独立状态：
{
  status: 'idle' | 'generating' | 'completed' | 'error',
  content: string,      // 流式累积的内容
  htmlContent: string,  // 提取的 HTML
  error: string | null
}

并行生成：
- 两个模型同时开始
- 各自独立更新状态
- 任一完成即可预览该侧
- 全部完成才能录制
```

---

## 相关文档

- **技术选型**: 详见 [00-技术选型.md](./00-技术选型.md)
- **接口设计**: 详见 [02-接口设计.md](./02-接口设计.md)
- **数据库设计**: 详见 [03-数据库设计.md](./03-数据库设计.md)
