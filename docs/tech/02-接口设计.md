# Novita Arena - 接口设计

**版本**: 1.3
**最后更新**: 2025-01-18
**状态**: 实现阶段（Sandbox 接口已完成）

---

## 目录

1. [认证接口](#1-认证接口)
2. [App 生成接口](#2-app-生成接口)
3. [媒体接口](#3-媒体接口)
4. [分享接口](#4-分享接口)
5. [画廊接口](#5-画廊接口)
6. [Sandbox 接口规范](#6-sandbox-接口规范)

---

## 1. 认证接口

### 1.1 GET /api/auth
**描述**：Novita Auth 回调入口

**请求**：
```typescript
// Novita 后端 Set-Cookie 后 307 跳转到此接口
// 无需额外参数
```

**响应**：
```typescript
{
  success: true,
  user: {
    id: "uuid",
    novitaUserId: "275",
    novitaUuid: "4d0b42a8-8c2e-4e28-b6b1-1920a78fc81c",
    email: "user@example.com",
    username: "username",
    firstName: "Jax",
    lastName: "Williams",
    tier: "T4",
    hasApiKey: false  // 是否已填 API Key
  },
  redirectUrl: string  // 跳转到最开始设置的 redirect_url
}
```

### 1.2 POST /api/auth/save-api-key
**描述**：保存 API Key

**请求**：
```typescript
{
  keyType: "novita" | "claude" | "other",
  apiKey: string
}
```

**响应**：
```typescript
{
  success: true,
  message: "API Key 已保存"
}
```

**错误**：
```typescript
{
  success: false,
  error: "API Key 验证失败"
}
```

---

## 2. App 生成接口

### 2.1 POST /api/apps/create
**描述**：创建 App（2 个 Sandbox 实例）

**请求**：
```typescript
{
  prompt: string,
  modelA: string,  // 例如：claude-3-5-sonnet
  modelB: string   // 例如：gpt-4o
}
```

**响应**：
```typescript
{
  success: true,
  appId: string,
  sandboxA: {
    id: string,              // sandbox ID
    hostUrl: string,         // https://port-id.sandbox.novita.ai
    previewPort: 3000,
    servicePort: 8000
  },
  sandboxB: {
    id: string,
    hostUrl: string,
    previewPort: 3000,
    servicePort: 8000
  }
}
```

**错误**：
```typescript
// 匿名用户，IP 已用完免费额度
{
  success: false,
  error: "免费额度已用完，请登录"
}

// 已登录用户，未填 API Key
{
  success: false,
  error: "请先填写 API Key"
}
```

### 2.2 POST /api/apps/:id/stop
**描述**：停止生成（销毁 Sandbox 实例）

**请求**：
```typescript
// 无需请求体
```

**响应**：
```typescript
{
  success: true,
  message: "已停止生成"
}
```

### 2.3 POST /api/apps/:id/update-video-url
**描述**：更新录屏视频 URL

**请求**：
```typescript
{
  previewVideoUrl: string  // Cloudflare Stream 预览 URL
}
```

**响应**：
```typescript
{
  success: true
}
```

---

## 3. 媒体接口

### 3.1 POST /api/media/upload-url
**描述**：生成 Cloudflare Stream 上传 URL

**请求**：
```typescript
{
  appId: string  // 可选，用于关联 app
}
```

**响应**：
```typescript
{
  success: true,
  uploadUrl: string,    // https://upload.cloudflarestream.com/...
  videoUid: string,     // 6b9e68b07dfee8cc2d116e4c51d6a957
  previewUrl: string      // https://customer-{CODE}.cloudflarestream.com/6b9e68b.../watch
}
```

---

## 4. 分享接口

### 4.1 POST /api/apps/:id/deploy
**描述**：开始 Vercel 部署

**请求**：
```typescript
// 无需请求体
```

**响应**：
```typescript
{
  success: true,
  message: "开始部署"
}
```

**错误**：
```typescript
{
  success: false,
  error: "权限不足，只能部署自己的 app"
}
```

### 4.2 GET /api/apps/:id/deploy-status
**描述**：查询部署状态

**响应**：
```typescript
{
  status: "deploying" | "completed" | "failed",
  vercelUrlA: string,  // 模型 A 的部署 URL
  vercelUrlB: string,  // 模型 B 的部署 URL
  progress: number      // 0-100
}
```

### 4.3 POST /api/apps/:id/publish
**描述**：发布到画廊（公开）

**请求**：
```typescript
{
  name: string,         // 应用名称（LLM 自动生成或用户编辑）
  description?: string  // 可选描述
}
```

**响应**：
```typescript
{
  success: true,
  message: "已发布到画廊"
}
```

---

## 5. 画廊接口

### 5.1 GET /api/apps
**描述**：获取应用列表

**查询参数**：
```
category: "hot" | "latest"  // 默认 latest
page: number                  // 默认 1
limit: number                 // 默认 20
```

**响应**：
```typescript
{
  apps: [{
    id: string,
    name: string,
    description?: string,
    prompt: string,
    modelA: string,
    modelB: string,
    previewVideoUrl?: string,  // 有视频优先显示视频，否则显示 Poster
    vercelUrlA?: string,
    vercelUrlB?: string,
    likeCount: number,
    viewCount: number,
    createdAt: string  // ISO 8601
  }],
  total: number,
  page: number,
  limit: number
}
```

### 5.2 GET /api/apps/:id
**描述**：获取应用详情

**响应**：
```typescript
{
  app: {
    id: string,
    userId: string,
    name: string,
    description?: string,
    prompt: string,
    modelA: string,
    modelB: string,
    sandboxIdA: string,
    sandboxIdB: string,
    sandboxHostUrlA: string,
    sandboxHostUrlB: string,
    vercelUrlA?: string,
    vercelUrlB?: string,
    previewVideoUrl?: string,
    isPublic: boolean,
    likeCount: number,
    viewCount: number,
    createdAt: string,
    isOwner: boolean  // 当前用户是否是作者
  }
}
```

### 5.3 POST /api/apps/:id/like
**描述**：点赞应用

**请求**：
```typescript
// 无需请求体
```

**响应**：
```typescript
{
  success: true,
  likeCount: number  // 新的点赞数
}
```

**错误**：
```typescript
{
  success: false,
  error: "已点赞" | "请先登录"
}
```

---

## 6. Sandbox 接口规范

> **实现说明**: Coding Agent 已完成实现并测试通过
> **版本**: 0.1.0
> **最后更新**: 2025-01-18
> **测试状态**: ✅ 所有功能已验证

### 6.1 POST /generate
**描述**：开始生成代码

**实现要点**：
- 单一 Session 管理（防重入）
- 如果已有 Session 运行，返回 success（不创建新 Session）
- 在后台异步执行代码生成
- 立即返回响应，不阻塞

**请求**：
```typescript
{
  prompt: string,
  workdir: string   // 工作目录，默认 /project
}
```

**响应**：
```typescript
{
  success: true
}
```

**错误**：
```typescript
{
  detail: "Workdir does not exist: /invalid/path"
}
```

### 6.2 GET /stream
**描述**：SSE 流式返回生成事件

**实现要点**：
- 全局单一 Session，无需 sessionId 参数
- 先重播所有历史事件（10ms 间隔）
- 如果 Session 运行中，继续流式传输实时事件
- 如果 Session 已完成，重播后结束流

**请求**：
```http
GET /stream
Accept: text/event-stream
```

**响应格式**：
```
data: {"type":"started","timestamp":1768708105.23,"data":{"model":"...","prompt":"..."}}
data: {"type":"system","timestamp":1768708106.32,"data":{"subtype":"init",...}}
data: {"type":"text","timestamp":1768708727.82,"data":{"text":"..."}}
data: {"type":"tool_use","timestamp":1768708134.84,"data":{"name":"Write",...}}
data: {"type":"tool_result","timestamp":1768708137.25,"data":{"content":"..."}}
data: {"type":"result","timestamp":1768708727.82,"data":{"subtype":"success",...}}
data: {"type":"completed","timestamp":1768708727.86,"data":{"success":true,...}}
```

**事件类型**：
| 类型 | 说明 |
|------|------|
| `started` | Agent 开始执行 |
| `system` | 系统元数据（初始化信息） |
| `text` | Claude 的文本响应 |
| `thinking` | Claude 的内部思考（扩展思考） |
| `tool_use` | 工具调用请求 |
| `tool_result` | 工具执行结果 |
| `pre_tool_use` | 工具执行前（含输入和时间） |
| `post_tool_use` | 工具执行后（含输出和 duration_ms） |
| `result` | 最终执行元数据（成本、用量、轮次） |
| `error` | 错误发生 |
| `completed` | Agent 成功完成 |

**错误**：
```typescript
{
  detail: "No active session"
}
```

### 6.3 POST /deploy
**描述**：部署到 Vercel

**实现要点**：
- 使用 `vercel -t <VERCEL_TOKEN> deploy --prod --yes` 命令
- Token 通过 `-t` 参数显式传递（环境变量不会被自动检测）
- 从 stdout 捕获部署 URL（根据 Vercel 官方文档）
- 验证 URL 格式（必须以 http:// 或 https:// 开头）
- 需要 VERCEL_TOKEN 环境变量

**环境变量**：
```
VERCEL_TOKEN=xxx  // 容器启动时传入，通过 -t 参数传递给 CLI
```

**实际命令**：
```bash
vercel -t $VERCEL_TOKEN deploy --prod --yes
```

**请求**：
```http
POST /deploy
```

**响应**：
```typescript
{
  vercelUrl: string  // https://your-app.vercel.app
}
```

**错误**：
```typescript
// 未设置 Vercel Token
{
  detail: "VERCEL_TOKEN environment variable not set"
}

// 没有 Session
{
  detail: "No session exists. Generate code first."
}

// 部署失败
{
  detail: "Deployment failed: <error details from stderr>"
}

// URL 格式无效
{
  detail: "Deployment returned invalid URL format: <url>"
}
```

### 6.4 GET /health
**描述**：健康检查

**响应**：
```typescript
{
  status: "ok",
  model: string  // 例如：deepseek/deepseek-v3.2
}
```

### 6.5 GET /
**描述**：API 信息

**响应**：
```typescript
{
  "name": "Coding Agent",
  "version": "0.1.0",
  "endpoints": {
    "POST /generate": "Start code generation (returns success)",
    "GET /stream": "SSE stream of generation events",
    "GET /health": "Health check",
    "POST /deploy": "Deploy to Vercel"
  }
}
```

---

## 相关文档

- **技术选型**: 详见 [00-技术选型.md](./00-技术选型.md)
- **使用流程**: 详见 [01-使用流程.md](./01-使用流程.md)
- **数据库设计**: 详见 [03-数据库设计.md](./03-数据库设计.md)
