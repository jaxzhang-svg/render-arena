# Novita Arena - 接口设计

**版本**: 2.0
**最后更新**: 2025-01-18
**状态**: 设计阶段

---

## 目录

1. [认证接口](#1-认证接口)
2. [App 生成接口](#2-app-生成接口)
3. [媒体接口](#3-媒体接口)
4. [画廊接口](#4-画廊接口)
5. [系统提示词](#5-系统提示词)

---

## 1. 认证接口

### 1.1 GET /api/auth

**描述**：Novita Auth 回调入口

**流程**：

1. Novita 后端 Set-Cookie 后跳转到此接口
2. 读取 Cookie，调用 Novita API 获取用户信息
3. 存储/更新用户到数据库
4. 设置 Session
5. 跳转到 redirect_url

**响应**：307 跳转

### 1.2 GET /api/auth/me

**描述**：获取当前用户信息

**响应**：

```typescript
{
  user: {
    id: string,
    email: string,
    username: string,
    firstName: string,
    lastName: string,
    tier: string,
    hasApiKey: boolean  // 是否已填 Novita API Key
  } | null
}
```

### 1.3 POST /api/auth/save-api-key

**描述**：保存 Novita API Key

**请求**：

```typescript
{
  apiKey: string
}
```

**响应**：

```typescript
{
  success: true,
  message: "API Key 已保存"
}
```

**错误**：

```typescript
{
  success: false,
  error: "API Key 验证失败"
}
```

### 1.4 POST /api/auth/logout

**描述**：登出

**响应**：

```typescript
{
  success: true
}
```

---

## 2. App 生成接口

### 2.1 POST /api/apps/create

**描述**：创建 App（生成任务）

**请求**：

```typescript
{
  prompt: string,
  modelA: string,  // 例如：deepseek/deepseek-v3-0324
  modelB: string   // 例如：meta-llama/llama-3.1-70b-instruct
}
```

**响应**：

```typescript
{
  success: true,
  appId: string  // UUID
}
```

**错误**：

```typescript
// 匿名用户，IP 已用完免费额度
{
  success: false,
  error: "FREE_QUOTA_EXCEEDED",
  message: "免费额度已用完，请登录"
}

// 已登录用户，未填 API Key
{
  success: false,
  error: "API_KEY_REQUIRED",
  message: "请先填写 Novita API Key"
}
```

### 2.2 GET /api/apps/:id/generate

**描述**：流式生成 HTML（SSE）

**查询参数**：

- `model`: `a` | `b` - 指定生成哪个模型的内容

**响应格式**：Server-Sent Events (SSE)

```
event: start
data: {"model":"deepseek/deepseek-v3-0324"}

event: content
data: {"text":"<!DOCTYPE html>"}

event: content
data: {"text":"\n<html lang=\"en\">"}

...（持续流式输出）...

event: done
data: {"success":true,"htmlContent":"<!DOCTYPE html>..."}

或

event: error
data: {"error":"Generation failed","message":"..."}
```

**事件类型**：

| 事件      | 说明     | data 格式                              |
| --------- | -------- | -------------------------------------- |
| `start`   | 开始生成 | `{model: string}`                      |
| `content` | 内容片段 | `{text: string}`                       |
| `done`    | 生成完成 | `{success: true, htmlContent: string}` |
| `error`   | 生成失败 | `{error: string, message: string}`     |

### 2.3 GET /api/apps/:id

**描述**：获取 App 详情

**响应**：

```typescript
{
  app: {
    id: string,
    userId: string | null,
    name: string | null,
    prompt: string,
    modelA: string,
    modelB: string,
    htmlContentA: string | null,
    htmlContentB: string | null,
    previewVideoUrl: string | null,
    isPublic: boolean,
    likeCount: number,
    viewCount: number,
    createdAt: string,  // ISO 8601
    isOwner: boolean    // 当前用户是否是作者
  }
}
```

### 2.4 POST /api/apps/:id/update

**描述**：更新 App 信息

**请求**：

```typescript
{
  name?: string,
  previewVideoUrl?: string
}
```

**响应**：

```typescript
{
  success: true
}
```

### 2.5 POST /api/apps/:id/regenerate

**描述**：重新生成（仅在生成失败时可用）

**查询参数**：

- `model`: `a` | `b` | `both` - 指定重新生成哪个模型

**响应**：同 2.2 GET /api/apps/:id/generate（SSE）

---

## 3. 媒体接口

### 3.1 POST /api/media/upload-url

**描述**：获取 Cloudflare Stream 上传 URL

**请求**：

```typescript
{
  appId?: string  // 可选，用于关联 app
}
```

**响应**：

```typescript
{
  success: true,
  uploadUrl: string,    // 一次性上传 URL
  videoUid: string,     // 视频 ID
  previewUrl: string    // 预览 URL
}
```

### 3.2 POST /api/apps/:id/generate-name

**描述**：使用 LLM 生成应用名称（可选功能）

**请求**：无（使用 app 的 prompt）

**响应**：

```typescript
{
  success: true,
  name: string  // 生成的名称，不超过 15 字
}
```

---

## 4. 画廊接口

### 4.1 GET /api/apps

**描述**：获取应用列表

**查询参数**：

```
category: "hot" | "latest"  // 默认 latest
page: number                 // 默认 1
limit: number                // 默认 20
```

**响应**：

```typescript
{
  apps: [{
    id: string,
    name: string,
    prompt: string,
    modelA: string,
    modelB: string,
    previewVideoUrl: string | null,
    likeCount: number,
    viewCount: number,
    createdAt: string
  }],
  total: number,
  page: number,
  limit: number
}
```

### 4.2 POST /api/apps/:id/publish

**描述**：发布到画廊

**请求**：

```typescript
{
  name: string,         // 应用名称
  description?: string  // 可选描述
}
```

**响应**：

```typescript
{
  success: true,
  message: "已发布到画廊"
}
```

### 4.3 POST /api/apps/:id/like

**描述**：点赞应用

**响应**：

```typescript
{
  success: true,
  likeCount: number,  // 新的点赞数
  liked: boolean      // 当前用户是否已点赞
}
```

**错误**：

```typescript
{
  success: false,
  error: "请先登录"
}
```

### 4.4 POST /api/apps/:id/view

**描述**：增加浏览次数

**响应**：

```typescript
{
  success: true,
  viewCount: number
}
```

---

## 5. 系统提示词

### 5.1 HTML 生成系统提示词

````markdown
你是一个 HTML 生成专家。根据用户需求生成完整的、可直接运行的单文件 HTML 应用。

## 输出要求

1. 输出一个完整的 HTML 文件
2. 使用 `<!DOCTYPE html>` 开头
3. 所有 CSS 写在 `<style>` 标签内（在 `<head>` 中）
4. 所有 JavaScript 写在 `<script>` 标签内（在 `</body>` 前）
5. 必须是自包含的，可直接在浏览器中运行

## 推荐的 CDN 库

根据需求选择使用以下库：

### 样式和交互

- **Tailwind CSS** (推荐用于快速样式):
  ```html
  <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
  ```
````

- **Alpine.js** (推荐用于简单交互):

  ```html
  <script src="https://unpkg.com/alpinejs" defer></script>
  ```

- **Lucide Icons** (推荐用于图标):
  ```html
  <script src="https://unpkg.com/lucide"></script>
  <!-- 使用: <i data-lucide="icon-name"></i> -->
  <!-- 初始化: lucide.createIcons() -->
  ```

### 可视化

- **Chart.js** (图表):

  ```html
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  ```

- **Three.js** (3D):
  ```html
  <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/0.180.0/three.min.js"></script>
  ```

### 动画

- **Anime.js** (动画):
  ```html
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js"></script>
  ```

### 创意编程

- **P5.js** (创意编程):
  ```html
  <script src="https://cdn.jsdelivr.net/npm/p5"></script>
  ```

## 代码规范

1. **响应式设计**: 使用 viewport meta 标签，适配移动端
2. **语义化 HTML**: 使用 header, main, footer, section 等语义标签
3. **标签闭合**: 所有非 void 元素必须正确闭合
4. **无外部依赖**: 除了上述 CDN 库，不引用其他外部资源
5. **可访问性**: 图片添加 alt 属性，表单添加 label

## 输出格式

只输出 HTML 代码，使用 markdown 代码块包裹，不要添加任何解释：

```html
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>应用标题</title>
    <!-- CDN 库 -->
    <style>
      /* 样式 */
    </style>
  </head>
  <body>
    <!-- 内容 -->
    <script>
      // 脚本
    </script>
  </body>
</html>
```

````

### 5.2 应用名称生成系统提示词

```markdown
你是一个应用命名专家。根据用户的提示词，生成一个简洁、吸引人的应用名称。

要求：
- 不超过 15 个字符
- 简洁明了，突出应用特点
- 可以使用 emoji（可选）
- 只输出名称，不要解释

示例：
- 提示词: "创建一个 3D 时钟" → "3D 粒子时钟"
- 提示词: "制作一个扫雷游戏" → "经典扫雷"
- 提示词: "创建销售数据仪表盘" → "销售数据看板"
````

---

## 相关文档

- **技术选型**: 详见 [00-技术选型.md](./00-技术选型.md)
- **使用流程**: 详见 [01-使用流程.md](./01-使用流程.md)
- **数据库设计**: 详见 [03-数据库设计.md](./03-数据库设计.md)
