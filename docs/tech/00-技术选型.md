# Novita Arena - 技术选型

**版本**: 2.0
**最后更新**: 2025-01-18
**状态**: 设计阶段

---

## 目录

1. [架构原则](#1-架构原则)
2. [前端技术栈](#2-前端技术栈)
3. [后端技术栈](#3-后端技术栈)
4. [外部服务集成](#4-外部服务集成)
5. [核心设计决策](#5-核心设计决策)
6. [生成的HTML规范](#6-生成的html规范)

---

## 1. 架构原则

### 1.1 极简优先

**核心理念**: 用最简单的方案实现产品目标，避免过度工程。

- **无 Sandbox**: 不再需要代码执行沙箱
- **无 Vercel 部署**: 不再需要托管生成的应用
- **单次 LLM 调用**: 直接生成完整 HTML 文件
- **浏览器直接预览**: 使用 iframe srcdoc 渲染

### 1.2 新架构 vs 旧架构

**旧架构** (已废弃):

```
User Prompt → Backend → Sandbox → Coding Agent → LLM →
  → npm install → vite build → Vercel Deploy → iframe预览
```

**新架构** (当前):

```
System Prompt + User Prompt → LLM API (流式) →
  → 生成完整 HTML → 保存数据库 → iframe srcdoc 预览
```

### 1.3 职责划分

**后端负责**:

- 用户认证（对接 Novita Auth）
- IP 额度控制
- 调用 LLM API（流式）
- 保存生成的 HTML 到数据库
- 录屏视频上传 URL 生成

**前端负责**:

- 流式展示生成过程（Markdown 代码块风格）
- HTML 预览（iframe srcdoc）
- HTML 有效性检测和自动修复
- 录屏和上传
- 状态管理和 UI 交互

---

## 2. 前端技术栈

| 技术                  | 版本         | 用途                 |
| --------------------- | ------------ | -------------------- |
| **Next.js**           | 15+          | 全栈框架，App Router |
| **React**             | 19+          | UI 框架              |
| **TypeScript**        | 5.x          | 类型安全             |
| **Tailwind CSS**      | 4.x          | 样式系统             |
| **shadcn/ui**         | Latest       | UI 组件库            |
| **Lucide Icons**      | lucide-react | 图标库               |
| **Zustand**           | Latest       | 状态管理             |
| **OpenAI SDK**        | Latest       | 流式响应处理         |
| **MediaRecorder API** | 浏览器原生   | 录屏功能             |
| **DOMParser**         | 浏览器原生   | HTML 验证和自动修复  |

---

## 3. 后端技术栈

| 技术                   | 说明       | 用途                         |
| ---------------------- | ---------- | ---------------------------- |
| **Next.js API Routes** | 服务端 API | 业务逻辑处理                 |
| **Supabase**           | PostgreSQL | 主数据库（含 HTML 内容存储） |
| **Novita LLM API**     | 外部服务   | AI 代码生成（流式）          |
| **Novita Auth**        | 外部服务   | 统一认证                     |
| **Cloudflare Stream**  | 外部服务   | 录屏视频存储                 |

---

## 4. 外部服务集成

### 4.1 Novita LLM API

**用途**: 生成 HTML 代码

**调用方式**:

- 使用 OpenAI 兼容的 SDK
- 流式响应 (SSE)
- 双模型并行调用（A vs B）

**请求示例**:

```typescript
import OpenAI from 'openai'

const client = new OpenAI({
  baseURL: 'https://api.novita.ai/v3/openai',
  apiKey: process.env.NOVITA_API_KEY,
})

const stream = await client.chat.completions.create({
  model: 'deepseek/deepseek-v3-0324',
  messages: [
    { role: 'system', content: SYSTEM_PROMPT },
    { role: 'user', content: userPrompt },
  ],
  stream: true,
})
```

### 4.2 Novita Auth

**用途**: 统一认证

**流程**:

1. 用户跳转 `https://api.novita.ai/login?redirect_url={domain}/api/auth`
2. 登录后设置 Cookie
3. `/api/auth` 读取 Cookie，调用 `/v1/user/info` 获取用户信息
4. 存储用户信息，设置 Session

### 4.3 Cloudflare Stream

**用途**: 录屏视频存储

**方案**: Direct Creator Uploads

- 后端生成一次性上传 URL
- 前端直接上传到 Cloudflare
- 返回预览 URL

---

## 5. 核心设计决策

### 5.1 单次 LLM 调用生成 HTML

**设计要点**:

- 不再使用 Coding Agent 多轮对话
- 系统提示词约束 LLM 只输出一个完整 HTML 文件
- 流式返回，前端实时展示生成过程

**优势**:

- 生成速度快（无构建步骤）
- 架构简单（无沙箱依赖）
- 成本可控（单次调用）

### 5.2 双模型并行生成

**设计要点**:

- 前端同时发起两个流式请求（模型 A 和模型 B）
- 使用 `Promise.all` 或独立状态管理
- 两边独立展示生成进度

### 5.3 HTML 验证和自动修复

**方案**: 使用浏览器原生 DOMParser

```typescript
function validateAndFixHTML(html: string) {
  const parser = new DOMParser()
  const doc = parser.parseFromString(html, 'text/html')

  const hasError = !!doc.querySelector('parsererror')
  const fixedHTML = doc.body.innerHTML

  return {
    isValid: !hasError,
    fixedHTML,
    needsFix: html !== fixedHTML,
  }
}
```

**错误处理流程**:

1. 生成完成后，调用验证函数
2. 如果可修复，使用修复后的 HTML
3. 如果无法修复，显示错误信息 + 重试按钮

### 5.4 HTML 内容存储

**方案**: 直接存储在 PostgreSQL TEXT 字段

- 最大 1MB 大小限制
- 按 app_id 索引
- 区分模型 A 和模型 B 的内容

### 5.5 预览方式

**方案**: iframe srcdoc

```tsx
<iframe srcdoc={htmlContent} sandbox="allow-scripts allow-forms" className="h-full w-full" />
```

**安全性**:

- 使用 sandbox 属性限制权限
- 禁止访问父页面 DOM
- 禁止弹窗和导航

### 5.6 流式展示 UI

**方案**: Markdown 代码块风格（终端风格）

- 黑底/深色背景
- 等宽字体
- 打字机效果
- 无语法高亮（避免视觉干扰）

---

## 6. 生成的 HTML 规范

### 6.1 系统提示词策略

**不使用固定模板**，而是通过系统提示词推荐最佳实践：

````markdown
你是一个 HTML 生成专家。根据用户需求生成完整的、可直接运行的单文件 HTML 应用。

## 输出要求

- 输出一个完整的 HTML 文件，包含所有 CSS 和 JavaScript
- 使用 <!DOCTYPE html> 开头
- 所有样式写在 <style> 标签内
- 所有脚本写在 <script> 标签内

## 推荐的 CDN 库（按需使用）

- **Tailwind CSS**: `<script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>`
- **Alpine.js**: `<script src="https://unpkg.com/alpinejs" defer></script>`
- **Lucide Icons**: `<script src="https://unpkg.com/lucide"></script>`
- **Chart.js**: `<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>`
- **Three.js**: `<script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/0.180.0/three.min.js"></script>`
- **Anime.js**: `<script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js"></script>`

## 代码规范

- 响应式设计（mobile-first）
- 语义化 HTML 标签
- 所有标签正确闭合
- 无外部依赖（除 CDN 外）

## 输出格式

只输出 HTML 代码，不要解释。使用 markdown 代码块包裹：

```html
<!DOCTYPE html> ...
```
````

````

### 6.2 推荐的 CDN 库

| 库 | 用途 | CDN URL | 大小 |
|---|------|---------|------|
| **Tailwind CSS** | 样式 | `@tailwindcss/browser@4` | ~25KB |
| **Alpine.js** | 交互 | `unpkg.com/alpinejs` | ~7KB |
| **Lucide Icons** | 图标 | `unpkg.com/lucide` | 按需 |
| **Chart.js** | 图表 | `cdn.jsdelivr.net/npm/chart.js` | ~66KB |
| **Three.js** | 3D | `cdnjs.cloudflare.com/.../three.min.js` | ~108KB |
| **Anime.js** | 动画 | `cdnjs.cloudflare.com/.../anime.min.js` | ~7KB |
| **P5.js** | 创意编程 | `cdn.jsdelivr.net/npm/p5` | ~200KB |

### 6.3 HTML 提取策略

从 LLM 响应中提取 HTML：

```typescript
function extractHTML(response: string): string | null {
  // 匹配 markdown 代码块中的 HTML
  const match = response.match(/```html\n([\s\S]*?)\n```/);
  if (match) {
    return match[1].trim();
  }

  // 如果没有代码块，检查是否直接返回 HTML
  if (response.trim().startsWith('<!DOCTYPE html>')) {
    return response.trim();
  }

  return null;
}
````

---

## 相关文档

- **使用流程**: 详见 [01-使用流程.md](./01-使用流程.md)
- **接口设计**: 详见 [02-接口设计.md](./02-接口设计.md)
- **数据库设计**: 详见 [03-数据库设计.md](./03-数据库设计.md)
